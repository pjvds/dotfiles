# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Start configuration added by Zim Framework install {{{
#
# User configuration sourced by interactive shells
#

# -----------------
# Zsh configuration
# -----------------

#
# History
#

# Remove older command from the history if a duplicate is to be added.
setopt HIST_IGNORE_ALL_DUPS

#
# Input/output
#

# Set editor default keymap to vi (`-v`)
bindkey -v

# Remove path separator from WORDCHARS.
WORDCHARS=${WORDCHARS//[\/]}

# --------------------
# Module configuration
# --------------------

#
# zsh-vi-mode
#

# Initialize immediately during sourcing instead of on first prompt
# This ensures proper plugin load order with fzf-tab and atuin
ZVM_INIT_MODE=sourcing

# Disable lazy keybindings to prevent overriding atuin
# We'll set atuin bindings in the after_lazy_keybindings hook instead
ZVM_LAZY_KEYBINDINGS=false

#
# zsh-autosuggestions
#

# Disable automatic widget re-binding on each precmd. This can be set when
# zsh-users/zsh-autosuggestions is the last module in your ~/.zimrc.
ZSH_AUTOSUGGEST_MANUAL_REBIND=1

# ------------------
# Initialize modules
# ------------------

ZIM_HOME=${ZDOTDIR:-${HOME}}/.zim
# Download zimfw plugin manager if missing.
if [[ ! -e ${ZIM_HOME}/zimfw.zsh ]]; then
  if (( ${+commands[curl]} )); then
    curl -fsSL --create-dirs -o ${ZIM_HOME}/zimfw.zsh \
        https://github.com/zimfw/zimfw/releases/latest/download/zimfw.zsh
  else
    mkdir -p ${ZIM_HOME} && wget -nv -O ${ZIM_HOME}/zimfw.zsh \
        https://github.com/zimfw/zimfw/releases/latest/download/zimfw.zsh
  fi
fi
# Install missing modules, and update ${ZIM_HOME}/init.zsh if missing or outdated.
if [[ ! ${ZIM_HOME}/init.zsh -nt ${ZIM_CONFIG_FILE:-${ZDOTDIR:-${HOME}}/.zimrc} ]]; then
  source ${ZIM_HOME}/zimfw.zsh init
fi

# Initialize modules.
source ${ZIM_HOME}/init.zsh
# }}} End configuration added by Zim Framework install

# Override Zimfw completion module's menu select (conflicts with fzf-tab)
zstyle ':completion:*' menu no

export LANG="en_US.UTF-8"
export LC_ALL="POSIX"
export DOTFILES=$HOME/dotfiles

if [ "$ZSH_PROFILING" = 1 ];
then
  zmodload zsh/zprof
fi

export HISTFILE=$HOME/.zsh_history
export HISTSIZE=10000000
export SAVEHIST=10000000

setopt BANG_HIST                   # Treat the '!' character specially during expansion.
setopt EXTENDED_HISTORY            # Write the history file in the ":start:elapsed;command" format.
setopt INC_APPEND_HISTORY          # Write to the history file immediately, not when the shell exits.
setopt SHARE_HISTORY               # Share history between all sessions.
setopt HIST_EXPIRE_DUPS_FIRST      # Expire duplicate entries first when trimming history.
setopt HIST_IGNORE_DUPS            # Don't record an entry that was just recorded again.
setopt HIST_IGNORE_ALL_DUPS        # Delete old recorded entry if new entry is a duplicate.
setopt HIST_FIND_NO_DUPS           # Do not display a line previously found.
setopt HIST_IGNORE_SPACE           # Don't record an entry starting with a space.
setopt HIST_SAVE_NO_DUPS           # Don't write duplicate entries in the history file.
setopt HIST_REDUCE_BLANKS          # Remove superfluous blanks before recording entry.
setopt HIST_VERIFY                 # Don't execute immediately upon history expansion.
setopt HIST_BEEP                   # Beep when accessing nonexistent history.
# setopt MENU_COMPLETE             # Disabled - conflicts with fzf-tab completion
setopt NO_NOMATCH                  # stop zsh from catching ^ chars.
setopt INTERACTIVE_COMMENTS        # allow comments in interactive shells

# Load custom dotfiles framework
source $DOTFILES/init.zsh

# Detect OS once for all platform-specific files
os="${$(uname):l}"

for file in $DOTFILES/**/preinit.zsh; do 
  [ -f $file ] && source $file
done

for file in $DOTFILES/**/preinit.$os.zsh; do 
  [ -f $file ] && source $file
done

for file in $DOTFILES/**/init.zsh; do 
  [ -f $file ] && source $file
done

for file in $DOTFILES/**/init.$os.zsh; do 
  [ -f $file ] && source $file
done

for file in $DOTFILES/**/postinit.zsh; do 
  [ -f $file ] && source $file
done

for file in $DOTFILES/**/postinit.$os.zsh; do 
  [ -f $file ] && source $file
done

for file in $DOTFILES/**/aliases.zsh; do 
  [ -f $file ] && source $file
done

for file in $DOTFILES/**/aliases.$os.zsh; do 
  [ -f $file ] && source $file
done

# Enter command mode with jj
bindkey 'jj' vi-cmd-mode

# Exit terminal with qq
exit_zsh() { exit }
zle -N exit_zsh
bindkey 'qq' exit_zsh

# Note: Atuin must be initialized AFTER zsh-vi-mode to preserve keybindings
# zsh-vi-mode resets all keybindings during initialization
# So we initialize atuin at the very end of zshrc

# Cycle through history based on characters already typed on the line
# These will override atuin's up/down if you prefer substring search
# Uncomment if you want traditional zsh history search instead of atuin:
# autoload -U up-line-or-beginning-search
# autoload -U down-line-or-beginning-search
# zle -N up-line-or-beginning-search
# zle -N down-line-or-beginning-search
# bindkey "^[[A" history-beginning-search-backward
# bindkey "^[[B" history-beginning-search-forward

# Initialize atuin NOW (after all plugins and vi-mode are loaded)
if command -v atuin &> /dev/null; then
  eval "$(atuin init zsh)"
fi

if [ "$ZSH_PROFILING" = 1 ];
then
  zprof
fi

# The following lines have been added by Docker Desktop to enable Docker CLI completions.
fpath=(/Users/pvandesande/.docker/completions $fpath)
# End of Docker CLI completions

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh
