# Start configuration added by Zim Framework install {{{
#
# User configuration sourced by interactive shells
#

# -----------------
# Zsh configuration
# -----------------

#
# History
#

# Remove older command from the history if a duplicate is to be added.
setopt HIST_IGNORE_ALL_DUPS

#
# Input/output
#

# Set editor default keymap to vi (`-v`)
bindkey -v

# Remove path separator from WORDCHARS.
WORDCHARS=${WORDCHARS//[\/]}

# --------------------
# Module configuration
# --------------------

#
# git
#

# Set a custom prefix for the generated aliases. The default prefix is 'G'.
#zstyle ':zim:git' aliases-prefix 'g'

#
# input
#

# Append `../` to your input for each `.` you type after an initial `..`
#zstyle ':zim:input' double-dot-expand yes

#
# termtitle
#

# Set a custom terminal title format using prompt expansion escape sequences.
# See http://zsh.sourceforge.net/Doc/Release/Prompt-Expansion.html#Simple-Prompt-Escapes
# If none is provided, the default '%n@%m: %~' is used.
#zstyle ':zim:termtitle' format '%1~'

#
# zsh-autosuggestions
#

# Disable automatic widget re-binding on each precmd. This can be set when
# zsh-users/zsh-autosuggestions is the last module in your ~/.zimrc.
ZSH_AUTOSUGGEST_MANUAL_REBIND=1

# Customize the style that the suggestions are shown with.
# See https://github.com/zsh-users/zsh-autosuggestions/blob/master/README.md#suggestion-highlight-style
#ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg=242'

#
# zsh-syntax-highlighting
#

# Set what highlighters will be used.
# See https://github.com/zsh-users/zsh-syntax-highlighting/blob/master/docs/highlighters.md
ZSH_HIGHLIGHT_HIGHLIGHTERS=(main brackets)

# Customize the main highlighter styles.
# See https://github.com/zsh-users/zsh-syntax-highlighting/blob/master/docs/highlighters/main.md#how-to-tweak-it
#typeset -A ZSH_HIGHLIGHT_STYLES
#ZSH_HIGHLIGHT_STYLES[comment]='fg=242'

# ------------------
# Initialize modules
# ------------------

ZIM_HOME=${ZDOTDIR:-${HOME}}/.zim
# Download zimfw plugin manager if missing.
if [[ ! -e ${ZIM_HOME}/zimfw.zsh ]]; then
  if (( ${+commands[curl]} )); then
    curl -fsSL --create-dirs -o ${ZIM_HOME}/zimfw.zsh \
        https://github.com/zimfw/zimfw/releases/latest/download/zimfw.zsh
  else
    mkdir -p ${ZIM_HOME} && wget -nv -O ${ZIM_HOME}/zimfw.zsh \
        https://github.com/zimfw/zimfw/releases/latest/download/zimfw.zsh
  fi
fi
# Install missing modules, and update ${ZIM_HOME}/init.zsh if missing or outdated.
if [[ ! ${ZIM_HOME}/init.zsh -nt ${ZIM_CONFIG_FILE:-${ZDOTDIR:-${HOME}}/.zimrc} ]]; then
  source ${ZIM_HOME}/zimfw.zsh init
fi
# Initialize modules.
source ${ZIM_HOME}/init.zsh
# }}} End configuration added by Zim Framework install

# Initialize zsh-cwd plugin (requires calling cwd function after loading)
if (( ${+functions[cwd]} )); then
  cwd
fi

export LANG="en_US.UTF-8"
export LC_ALL="POSIX"
export DOTFILES=$HOME/dotfiles

if [ "$ZSH_PROFILING" = 1 ];
then
  zmodload zsh/zprof
fi

export HISTFILE=$HOME/.zsh_history
export HISTSIZE=10000000
export SAVEHIST=10000000

setopt BANG_HIST                   # Treat the '!' character specially during expansion.
setopt EXTENDED_HISTORY            # Write the history file in the ":start:elapsed;command" format.
setopt INC_APPEND_HISTORY          # Write to the history file immediately, not when the shell exits.
setopt SHARE_HISTORY               # Share history between all sessions.
setopt HIST_EXPIRE_DUPS_FIRST      # Expire duplicate entries first when trimming history.
setopt HIST_IGNORE_DUPS            # Don't record an entry that was just recorded again.
setopt HIST_IGNORE_ALL_DUPS        # Delete old recorded entry if new entry is a duplicate.
setopt HIST_FIND_NO_DUPS           # Do not display a line previously found.
setopt HIST_IGNORE_SPACE           # Don't record an entry starting with a space.
setopt HIST_SAVE_NO_DUPS           # Don't write duplicate entries in the history file.
setopt HIST_REDUCE_BLANKS          # Remove superfluous blanks before recording entry.
setopt HIST_VERIFY                 # Don't execute immediately upon history expansion.
setopt HIST_BEEP                   # Beep when accessing nonexistent history.
setopt MENU_COMPLETE               # select first menu option automatically
setopt NO_NOMATCH                  # stop zsh from catching ^ chars.
setopt INTERACTIVE_COMMENTS        # allow comments in interactive shells

zstyle ":completion:*" menu select # Higlight item in completion menu

# Load custom dotfiles framework
source $DOTFILES/init.zsh
for file in $DOTFILES/**/preinit.zsh; do 
  [ -f $file ] && source $file
done

os="${$(uname):l}"
for file in $DOTFILES/**/preinit.$os.zsh; do 
  [ -f $file ] && source $file
done

for file in $DOTFILES/**/init.zsh; do 
  [ -f $file ] && source $file
done

os="${$(uname):l}"
for file in $DOTFILES/**/init.$os.zsh; do 
  [ -f $file ] && source $file
done

for file in $DOTFILES/**/postinit.zsh; do 
  [ -f $file ] && source $file
done

os="${$(uname):l}"
for file in $DOTFILES/**/postinit.$os.zsh; do 
  [ -f $file ] && source $file
done

for file in $DOTFILES/**/aliases.zsh; do 
  [ -f $file ] && source $file
done

for file in $DOTFILES/**/aliases.$os.zsh; do 
  [ -f $file ] && source $file
done

# Enter command mode with jj
bindkey 'jj' vi-cmd-mode

# Exit terminal with qq
exit_zsh() { exit }
zle -N exit_zsh
bindkey 'qq' exit_zsh

# Atuin history replacement
# Note: Loaded manually here instead of via zimfw
# Atuin will handle up/down arrows for history search
# Use Ctrl+R for interactive atuin search
if command -v atuin &> /dev/null; then
  eval "$(atuin init zsh)"
fi

# Cycle through history based on characters already typed on the line
# These will override atuin's up/down if you prefer substring search
# Uncomment if you want traditional zsh history search instead of atuin:
# autoload -U up-line-or-beginning-search
# autoload -U down-line-or-beginning-search
# zle -N up-line-or-beginning-search
# zle -N down-line-or-beginning-search
# bindkey "^[[A" history-beginning-search-backward
# bindkey "^[[B" history-beginning-search-forward

if [ "$ZSH_PROFILING" = 1 ];
then
  zprof
fi

# The following lines have been added by Docker Desktop to enable Docker CLI completions.
fpath=(/Users/pvandesande/.docker/completions $fpath)
# End of Docker CLI completions
